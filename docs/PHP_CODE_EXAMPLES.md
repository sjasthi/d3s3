# PHP Code Examples for Simplified Schema

## Table of Contents
1. [Patients - Create & Query](#1-patients)
2. [Patient Code Generation Explained](#2-patient-code-generation)
3. [Case Sheets (with Closures)](#3-case-sheets)
4. [Messages (Simplified)](#4-messages)
5. [Events](#5-events)
6. [Patient Feedback](#6-patient-feedback)

---

## 1. Patients

### Create a New Patient
```php
<?php
require_once __DIR__ . '/app/config/database.php';

$pdo = getDBConnection();

// The patient_code will be AUTO-GENERATED by the trigger!
// You don't need to generate it manually
$stmt = $pdo->prepare('
    INSERT INTO patients (
        first_name, last_name, sex, date_of_birth,
        phone_e164, email,
        blood_group, allergies,
        first_seen_date
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
');

$stmt->execute([
    'John',
    'Doe',
    'MALE',
    '1985-03-15',
    '+919876543210',
    'john.doe@example.com',
    'O+',
    'Penicillin, Peanuts',
    '2026-02-06'  // Will generate code: 20260206XXX
]);

$patientId = $pdo->lastInsertId();

// Retrieve the auto-generated patient_code
$stmt = $pdo->prepare('SELECT patient_code FROM patients WHERE patient_id = ?');
$stmt->execute([$patientId]);
$patientCode = $stmt->fetchColumn();

echo "Patient created with ID: $patientId, Code: $patientCode\n";
// Output: Patient created with ID: 2, Code: 20260206001
```

### Query Patients
```php
// Search by name
$stmt = $pdo->prepare('
    SELECT patient_id, patient_code, first_name, last_name, phone_e164, email
    FROM patients
    WHERE first_name LIKE ? OR last_name LIKE ?
    ORDER BY last_name, first_name
');
$stmt->execute(["%$searchTerm%", "%$searchTerm%"]);
$patients = $stmt->fetchAll();

// Search by patient_code (exact match)
$stmt = $pdo->prepare('
    SELECT * FROM patients WHERE patient_code = ? LIMIT 1
');
$stmt->execute(['20260206001']);
$patient = $stmt->fetch();

// Get patient with portal account info
$stmt = $pdo->prepare('
    SELECT
        patient_id, patient_code, first_name, last_name,
        email, phone_e164,
        username, last_login_at,
        blood_group, allergies
    FROM patients
    WHERE patient_id = ?
');
$stmt->execute([$patientId]);
$patient = $stmt->fetch();

// Check if patient has portal account
if ($patient['username'] !== null) {
    echo "Patient has portal access: " . $patient['username'];
} else {
    echo "Patient does not have portal access";
}
```

### Create Patient Portal Account
```php
// Update existing patient to add portal access
$stmt = $pdo->prepare('
    UPDATE patients
    SET username = ?,
        password_hash = ?,
        email = ?
    WHERE patient_id = ?
');

$stmt->execute([
    'john.doe',
    password_hash('securePassword123', PASSWORD_DEFAULT),
    'john.doe@example.com',
    $patientId
]);
```

### Patient Portal Login
```php
function patientLogin($username, $password) {
    $pdo = getDBConnection();

    // Find patient by username
    $stmt = $pdo->prepare('
        SELECT patient_id, patient_code, first_name, last_name,
               username, password_hash, is_active
        FROM patients
        WHERE username = ?
        LIMIT 1
    ');
    $stmt->execute([$username]);
    $patient = $stmt->fetch();

    // Verify password
    if (!$patient || !password_verify($password, $patient['password_hash'])) {
        return ['error' => 'Invalid username or password'];
    }

    if (!$patient['is_active']) {
        return ['error' => 'Account is inactive'];
    }

    // Update last login
    $pdo->prepare('UPDATE patients SET last_login_at = NOW() WHERE patient_id = ?')
        ->execute([$patient['patient_id']]);

    // Start session
    session_regenerate_id(true);
    $_SESSION['patient_id'] = $patient['patient_id'];
    $_SESSION['patient_code'] = $patient['patient_code'];
    $_SESSION['patient_name'] = $patient['first_name'] . ' ' . $patient['last_name'];

    return ['success' => true];
}
```

---

## 2. Patient Code Generation

### How the YYYYMMDDNNN Format Works

The **patient_code** is automatically generated when you insert a new patient using a database trigger.

#### Example Timeline:
```
Date: 2026-02-06

Patient 1 created → Code: 20260206001
Patient 2 created → Code: 20260206002
Patient 3 created → Code: 20260206003
...
Patient 10 created → Code: 20260206010
...
Patient 999 created → Code: 20260206999

Next Day (2026-02-07):
Patient created → Code: 20260207001  (counter resets!)
```

### The Database Mechanism

**patient_daily_sequence Table:**
```sql
seq_date    | last_n
------------|-------
2026-02-06  | 3      -- 3 patients registered today
2026-02-07  | 1      -- 1 patient registered today
```

**The Trigger (already created):**
```sql
-- This runs AUTOMATICALLY before every INSERT into patients table
CREATE TRIGGER trg_patients_before_insert
BEFORE INSERT ON patients
FOR EACH ROW
BEGIN
  DECLARE v_date DATE;
  DECLARE v_seq INT UNSIGNED;

  -- Use the first_seen_date (defaults to today if not provided)
  SET v_date = IFNULL(NEW.first_seen_date, CURDATE());
  SET NEW.first_seen_date = v_date;

  -- Get next sequence number for this date
  -- This is ATOMIC and thread-safe!
  INSERT INTO patient_daily_sequence (seq_date, last_n)
  VALUES (v_date, 1)
  ON DUPLICATE KEY UPDATE last_n = LAST_INSERT_ID(last_n + 1);

  SET v_seq = LAST_INSERT_ID();

  -- Build patient_code: YYYYMMDDNNN
  SET NEW.patient_code = CONCAT(
    DATE_FORMAT(v_date, '%Y%m%d'),  -- 20260206
    LPAD(v_seq, 3, '0')             -- 001, 002, 003...
  );
END;
```

### Why This Approach?

**✅ Advantages:**
1. **Automatic** - No PHP code needed
2. **Thread-safe** - No race conditions (multiple simultaneous inserts are safe)
3. **Consistent** - Format is always YYYYMMDDNNN
4. **Simple trigger** - Only 10 lines, easy to understand
5. **Reliable** - MySQL handles the sequence atomically

**❌ PHP Alternative Would Have Issues:**
```php
// DON'T DO THIS - Race condition risk!
$stmt = $pdo->query('SELECT last_n FROM patient_daily_sequence WHERE seq_date = CURDATE()');
$lastN = $stmt->fetchColumn() ?? 0;
$newN = $lastN + 1;  // ⚠️ Another request might get same number!
$pdo->exec("UPDATE patient_daily_sequence SET last_n = $newN");
```

### Manually Query Sequence
```php
// How many patients registered today?
$stmt = $pdo->prepare('
    SELECT last_n FROM patient_daily_sequence WHERE seq_date = CURDATE()
');
$stmt->execute();
$count = $stmt->fetchColumn() ?? 0;
echo "Patients registered today: $count";

// How many patients registered on a specific date?
$stmt = $pdo->prepare('
    SELECT last_n FROM patient_daily_sequence WHERE seq_date = ?
');
$stmt->execute(['2026-02-06']);
$count = $stmt->fetchColumn() ?? 0;
```

---

## 3. Case Sheets (with Closures)

### Create a New Case Sheet
```php
$stmt = $pdo->prepare('
    INSERT INTO case_sheets (
        patient_id, visit_datetime, visit_type,
        created_by_user_id, assigned_doctor_user_id,
        chief_complaint, diagnosis, prescriptions
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
');

$stmt->execute([
    $patientId,
    date('Y-m-d H:i:s'),
    'CLINIC',
    $_SESSION['user_id'],  // Current logged-in user
    5,  // Doctor user_id
    'Persistent cough for 2 weeks',
    'Acute bronchitis',
    'Amoxicillin 500mg TID x 7 days'
]);

$caseSheetId = $pdo->lastInsertId();
```

### Close a Case Sheet (Discharge)
```php
// Simple discharge
$stmt = $pdo->prepare('
    UPDATE case_sheets
    SET is_closed = 1,
        closed_at = NOW(),
        closed_by_user_id = ?,
        closure_type = \'DISCHARGED\',
        disposition = ?
    WHERE case_sheet_id = ?
');

$stmt->execute([
    $_SESSION['user_id'],
    'Patient recovered fully, no follow-up needed',
    $caseSheetId
]);

// Discharge with follow-up
$stmt = $pdo->prepare('
    UPDATE case_sheets
    SET is_closed = 1,
        closed_at = NOW(),
        closed_by_user_id = ?,
        closure_type = \'FOLLOW_UP\',
        disposition = ?,
        advice = ?,
        follow_up_date = ?
    WHERE case_sheet_id = ?
');

$stmt->execute([
    $_SESSION['user_id'],
    'Symptoms improving, scheduled follow-up',
    'Continue medication, rest, avoid cold foods',
    '2026-02-20',  // Follow-up date
    $caseSheetId
]);

// Referral case
$stmt = $pdo->prepare('
    UPDATE case_sheets
    SET is_closed = 1,
        closed_at = NOW(),
        closed_by_user_id = ?,
        closure_type = \'REFERRAL\',
        disposition = ?,
        referral_to = ?,
        referral_reason = ?
    WHERE case_sheet_id = ?
');

$stmt->execute([
    $_SESSION['user_id'],
    'Referred to specialist for further evaluation',
    'Dr. Smith - Cardiologist, City Hospital',
    'Abnormal ECG findings require specialist review',
    $caseSheetId
]);
```

### Query Case Sheets
```php
// Get all visits for a patient
$stmt = $pdo->prepare('
    SELECT
        cs.case_sheet_id, cs.visit_datetime, cs.visit_type,
        cs.chief_complaint, cs.diagnosis,
        cs.is_closed, cs.closure_type,
        u1.first_name as doctor_first_name,
        u1.last_name as doctor_last_name
    FROM case_sheets cs
    LEFT JOIN users u1 ON cs.assigned_doctor_user_id = u1.user_id
    WHERE cs.patient_id = ?
    ORDER BY cs.visit_datetime DESC
');
$stmt->execute([$patientId]);
$visits = $stmt->fetchAll();

// Get open (pending) cases
$stmt = $pdo->query('
    SELECT
        cs.case_sheet_id, cs.visit_datetime,
        p.patient_code, p.first_name, p.last_name,
        cs.chief_complaint
    FROM case_sheets cs
    INNER JOIN patients p ON cs.patient_id = p.patient_id
    WHERE cs.is_closed = 0
    ORDER BY cs.visit_datetime DESC
');
$openCases = $stmt->fetchAll();

// Get cases requiring follow-up
$stmt = $pdo->query('
    SELECT
        cs.case_sheet_id, cs.follow_up_date,
        p.patient_code, p.first_name, p.last_name, p.phone_e164
    FROM case_sheets cs
    INNER JOIN patients p ON cs.patient_id = p.patient_id
    WHERE cs.closure_type = \'FOLLOW_UP\'
      AND cs.follow_up_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)
    ORDER BY cs.follow_up_date
');
$upcomingFollowUps = $stmt->fetchAll();
```

---

## 4. Messages (Simplified)

### Send a Message
```php
// Staff sends message to patient
function staffSendMessage($patientId, $subject, $messageText, $caseSheetId = null) {
    $pdo = getDBConnection();

    $stmt = $pdo->prepare('
        INSERT INTO messages (
            patient_id, sender_type, sender_user_id,
            subject, message_text, case_sheet_id
        ) VALUES (?, \'STAFF\', ?, ?, ?, ?)
    ');

    $stmt->execute([
        $patientId,
        $_SESSION['user_id'],  // Current logged-in staff
        $subject,
        $messageText,
        $caseSheetId
    ]);

    return $pdo->lastInsertId();
}

// Patient sends message (from portal)
function patientSendMessage($subject, $messageText, $caseSheetId = null) {
    $pdo = getDBConnection();

    $stmt = $pdo->prepare('
        INSERT INTO messages (
            patient_id, sender_type, sender_user_id,
            subject, message_text, case_sheet_id
        ) VALUES (?, \'PATIENT\', NULL, ?, ?, ?)
    ');

    $stmt->execute([
        $_SESSION['patient_id'],  // From patient portal session
        $subject,
        $messageText,
        $caseSheetId
    ]);

    return $pdo->lastInsertId();
}
```

### Retrieve Messages
```php
// Get all messages for a patient (conversation view)
$stmt = $pdo->prepare('
    SELECT
        m.message_id, m.sent_at, m.sender_type,
        m.subject, m.message_text, m.is_read,
        u.first_name as staff_first_name,
        u.last_name as staff_last_name,
        p.first_name as patient_first_name,
        p.last_name as patient_last_name
    FROM messages m
    LEFT JOIN users u ON m.sender_user_id = u.user_id
    INNER JOIN patients p ON m.patient_id = p.patient_id
    WHERE m.patient_id = ?
    ORDER BY m.sent_at DESC
');
$stmt->execute([$patientId]);
$messages = $stmt->fetchAll();

// Display in view
foreach ($messages as $msg) {
    if ($msg['sender_type'] === 'PATIENT') {
        echo "Patient: " . htmlspecialchars($msg['message_text']);
    } else {
        echo "Staff (" . htmlspecialchars($msg['staff_first_name']) . "): ";
        echo htmlspecialchars($msg['message_text']);
    }
}
```

### Mark as Read
```php
$stmt = $pdo->prepare('
    UPDATE messages
    SET is_read = 1, read_at = NOW()
    WHERE message_id = ?
');
$stmt->execute([$messageId]);
```

### Get Unread Message Count
```php
// For patient portal - show badge with unread count
$stmt = $pdo->prepare('
    SELECT COUNT(*) FROM messages
    WHERE patient_id = ? AND is_read = 0 AND sender_type = \'STAFF\'
');
$stmt->execute([$_SESSION['patient_id']]);
$unreadCount = $stmt->fetchColumn();

// For staff dashboard - show all unread from patients
$stmt = $pdo->query('
    SELECT COUNT(*) FROM messages
    WHERE is_read = 0 AND sender_type = \'PATIENT\'
');
$unreadFromPatients = $stmt->fetchColumn();
```

---

## 5. Events

### Create an Event
```php
$stmt = $pdo->prepare('
    INSERT INTO events (
        event_type, title, description,
        start_datetime, end_datetime,
        location_name, address, city, state_province,
        status, created_by_user_id
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, \'SCHEDULED\', ?)
');

$stmt->execute([
    'MEDICAL_CAMP',
    'Free Health Camp - Ward 12',
    'General checkup, blood pressure, diabetes screening',
    '2026-03-15 09:00:00',
    '2026-03-15 17:00:00',
    'Community Center',
    '123 Main Street',
    'Pune',
    'Maharashtra',
    $_SESSION['user_id']
]);
```

### Query Events
```php
// Upcoming events
$stmt = $pdo->query('
    SELECT * FROM events
    WHERE start_datetime >= NOW()
      AND status IN (\'SCHEDULED\', \'ACTIVE\')
    ORDER BY start_datetime
');
$upcomingEvents = $stmt->fetchAll();

// Events by type
$stmt = $pdo->prepare('
    SELECT * FROM events
    WHERE event_type = ?
    ORDER BY start_datetime DESC
');
$stmt->execute(['MEDICAL_CAMP']);
$camps = $stmt->fetchAll();
```

---

## 6. Patient Feedback

### Submit Feedback
```php
$stmt = $pdo->prepare('
    INSERT INTO patient_feedback (
        patient_id, case_sheet_id, related_user_id,
        feedback_type, rating, feedback_text
    ) VALUES (?, ?, ?, ?, ?, ?)
');

$stmt->execute([
    $_SESSION['patient_id'],
    $caseSheetId,  // Optional - related visit
    $doctorUserId,  // Optional - doctor this feedback is about
    'POSITIVE',
    5,  // 1-5 stars
    'Excellent care, very professional staff'
]);
```

### Query Feedback
```php
// Get all feedback for a patient
$stmt = $pdo->prepare('
    SELECT * FROM patient_feedback
    WHERE patient_id = ?
    ORDER BY created_at DESC
');
$stmt->execute([$patientId]);
$feedback = $stmt->fetchAll();

// Get unreviewed feedback
$stmt = $pdo->query('
    SELECT
        pf.*,
        p.first_name, p.last_name, p.patient_code
    FROM patient_feedback pf
    INNER JOIN patients p ON pf.patient_id = p.patient_id
    WHERE pf.status = \'NEW\'
    ORDER BY pf.created_at DESC
');
$newFeedback = $stmt->fetchAll();
```

---

## Complete Example: Patient Registration Flow

```php
<?php
session_start();
require_once __DIR__ . '/app/config/database.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $pdo = getDBConnection();

    try {
        $pdo->beginTransaction();

        // 1. Create patient record
        $stmt = $pdo->prepare('
            INSERT INTO patients (
                first_name, last_name, sex, date_of_birth,
                phone_e164, email,
                address_line1, city, state_province, postal_code,
                blood_group, allergies,
                emergency_contact_name, emergency_contact_phone,
                first_seen_date
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURDATE())
        ');

        $stmt->execute([
            $_POST['first_name'],
            $_POST['last_name'],
            $_POST['sex'],
            $_POST['date_of_birth'],
            $_POST['phone'],
            $_POST['email'],
            $_POST['address'],
            $_POST['city'],
            $_POST['state'],
            $_POST['postal_code'],
            $_POST['blood_group'],
            $_POST['allergies'],
            $_POST['emergency_name'],
            $_POST['emergency_phone']
        ]);

        $patientId = $pdo->lastInsertId();

        // 2. Get the auto-generated patient_code
        $stmt = $pdo->prepare('SELECT patient_code FROM patients WHERE patient_id = ?');
        $stmt->execute([$patientId]);
        $patientCode = $stmt->fetchColumn();

        // 3. Create initial case sheet
        $stmt = $pdo->prepare('
            INSERT INTO case_sheets (
                patient_id, visit_datetime, visit_type,
                created_by_user_id, chief_complaint
            ) VALUES (?, NOW(), \'CAMP\', ?, ?)
        ');

        $stmt->execute([
            $patientId,
            $_SESSION['user_id'],
            $_POST['chief_complaint']
        ]);

        $caseSheetId = $pdo->lastInsertId();

        $pdo->commit();

        $_SESSION['success'] = "Patient registered successfully! Code: $patientCode";
        header("Location: case_sheet.php?id=$caseSheetId");
        exit;

    } catch (Exception $e) {
        $pdo->rollBack();
        $_SESSION['error'] = "Registration failed: " . $e->getMessage();
        header("Location: patient_register.php");
        exit;
    }
}
?>
```

---

## Database Connection Helper

Make sure your `app/config/database.php` is set up:

```php
<?php
function getDBConnection(): PDO {
    static $pdo = null;

    if ($pdo === null) {
        // Load from .env file
        $envFile = __DIR__ . '/../../.env';
        if (file_exists($envFile)) {
            $lines = file($envFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
            foreach ($lines as $line) {
                if (strpos($line, '=') !== false && $line[0] !== '#') {
                    list($key, $value) = explode('=', $line, 2);
                    $_ENV[trim($key)] = trim($value);
                }
            }
        }

        $host = $_ENV['DB_HOST'] ?? 'localhost';
        $db   = $_ENV['DB_NAME'] ?? 'core_app';
        $user = $_ENV['DB_USER'] ?? 'root';
        $pass = $_ENV['DB_PASS'] ?? '';

        $dsn = "mysql:host=$host;dbname=$db;charset=utf8mb4";
        $pdo = new PDO($dsn, $user, $pass, [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false
        ]);
    }

    return $pdo;
}
```

---

## Testing the Patient Code Generation

```php
<?php
require_once __DIR__ . '/app/config/database.php';

$pdo = getDBConnection();

// Create 5 test patients
for ($i = 1; $i <= 5; $i++) {
    $stmt = $pdo->prepare('
        INSERT INTO patients (first_name, last_name, sex, first_seen_date)
        VALUES (?, ?, ?, CURDATE())
    ');
    $stmt->execute(["Test", "Patient $i", 'MALE']);
}

// Check generated codes
$stmt = $pdo->query('
    SELECT patient_id, patient_code, first_name, last_name, first_seen_date
    FROM patients
    ORDER BY patient_id DESC
    LIMIT 5
');

echo "Recently created patients:\n";
foreach ($stmt->fetchAll() as $p) {
    echo "ID: {$p['patient_id']}, Code: {$p['patient_code']}, ";
    echo "Name: {$p['first_name']} {$p['last_name']}, ";
    echo "Date: {$p['first_seen_date']}\n";
}

/* Output will be like:
ID: 6, Code: 20260206005, Name: Test Patient 5, Date: 2026-02-06
ID: 5, Code: 20260206004, Name: Test Patient 4, Date: 2026-02-06
ID: 4, Code: 20260206003, Name: Test Patient 3, Date: 2026-02-06
ID: 3, Code: 20260206002, Name: Test Patient 2, Date: 2026-02-06
ID: 2, Code: 20260206001, Name: Test Patient 1, Date: 2026-02-06
*/
```
